<p>{QUESTIONTEXT}</p>
<div id="map"></div>
<input id="geojson" name="geojson" type="hidden" value='{GEOJSON_TEXT}' />


<script>
    $().ready(function () {
        (function (win, doc) {
            'use strict';

            var markerImage = 'data:image/png;base64,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';

            //Drag interaction

            /**
             * Define a namespace for the application.
             */
            var app = {};

            /**
             * @constructor
             * @extends {ol.interaction.Pointer}
             */
            app.Drag = function () {
                ol.interaction.Pointer.call(this, {
                    handleDownEvent: app.Drag.prototype.handleDownEvent,
                    handleDragEvent: app.Drag.prototype.handleDragEvent,
                    handleMoveEvent: app.Drag.prototype.handleMoveEvent,
                    handleUpEvent: app.Drag.prototype.handleUpEvent
                });

                /**
                 * @type {ol.Pixel}
                 * @private
                 */
                this.coordinate_ = null;

                /**
                 * @type {string|undefined}
                 * @private
                 */
                this.cursor_ = 'pointer';

                /**
                 * @type {ol.Feature}
                 * @private
                 */
                this.feature_ = null;

                /**
                 * @type {string|undefined}
                 * @private
                 */
                this.previousCursor_ = undefined;

            };
            ol.inherits(app.Drag, ol.interaction.Pointer);


            /**
             * @param {ol.MapBrowserEvent} evt Map browser event.
             * @return {boolean} `true` to start the drag sequence.
             */
            app.Drag.prototype.handleDownEvent = function (evt) {
                var map = evt.map;

                var feature = map.forEachFeatureAtPixel(evt.pixel,
                    function (feature) {
                        return feature;
                    });

                if (feature) {
                    this.coordinate_ = evt.coordinate;
                    this.feature_ = feature;
                }

                return !!feature;
            };


            /**
             * @param {ol.MapBrowserEvent} evt Map browser event.
             */
            app.Drag.prototype.handleDragEvent = function (evt) {
                var deltaX = evt.coordinate[0] - this.coordinate_[0];
                var deltaY = evt.coordinate[1] - this.coordinate_[1];

                var geometry = /** @type {ol.geom.SimpleGeometry} */
                    (this.feature_.getGeometry());
                geometry.translate(deltaX, deltaY);

                this.coordinate_[0] = evt.coordinate[0];
                this.coordinate_[1] = evt.coordinate[1];

                var format = new ol.format.GeoJSON();
                var data;
                data = format.writeFeatures(vectorLayer.getSource().getFeatures(), {decimals: 6});
                $('#geojson').val(data);
            };


            /**
             * @param {ol.MapBrowserEvent} evt Event.
             */
            app.Drag.prototype.handleMoveEvent = function (evt) {
                if (this.cursor_) {
                    var map = evt.map;
                    var feature = map.forEachFeatureAtPixel(evt.pixel,
                        function (feature) {
                            return feature;
                        });
                    var element = evt.map.getTargetElement();
                    if (feature) {
                        if (element.style.cursor != this.cursor_) {
                            this.previousCursor_ = element.style.cursor;
                            element.style.cursor = this.cursor_;
                        }
                    } else if (this.previousCursor_ !== undefined) {
                        element.style.cursor = this.previousCursor_;
                        this.previousCursor_ = undefined;
                    }
                }
            };


            /**
             * @return {boolean} `false` to stop the drag sequence.
             */
            app.Drag.prototype.handleUpEvent = function () {
                this.coordinate_ = null;
                this.feature_ = null;
                return false;
            };

            //End drag interaction

            var existingGeoJSON = {GEOJSON};

            var view = new ol.View({
                    center: [0, 0],
                    zoom: 0,
                    projection: 'EPSG:4326',
                    minZoom: 0,
                    maxZoom: 4
                }),
                vectorLayer = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        wrapX: false,
                        format: new ol.format.GeoJSON()//.readFeatures(existingGeoJSON)
                    })
                }),
                    /*baseLayer = new ol.layer.Tile({
                     preload: Infinity,
                     opacity: 1,
                     source: new ol.source.MapQuest({layer: 'osm'})
                     }),*/
                imageLayer = new ol.layer.Image({
                    title: "image",
                    opacity: 1,
                    source: new ol.source.ImageStatic({
                        url: '{IMAGE_PATH}',
                        projection: 'EPSG:4326',
                        //url: 'uhd.jpg',
                        //ToDo Adjust dimensions according to uploaded image: +/-x:2 and +/-y:2 minx,miny,maxx,maxy
                        imageExtent: [-390, -303, 390, 303],
                        //Size in Pixels:
                        imageSize: [780, 606]
                    })
                }),
                map = new ol.Map({
                    interactions: ol.interaction.defaults().extend([new app.Drag()]),
                    logo: "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
                    target: doc.getElementById('map'),
                    //loadTilesWhileAnimating: true,
                    view: view,
                    layers: [imageLayer, vectorLayer]
                }),
                // from https://github.com/DmitryBaranovskiy/raphael

                elastic = function (t) {
                    return Math.pow(2, -10 * t) * Math.sin((t - 0.075) * (2 * Math.PI) / 0.3) + 1;
                },
                center = function (obj) {
                    var pan = ol.animation.pan({
                        duration: 1000,
                        easing: elastic,
                        source: view.getCenter()
                    });
                    map.beforeRender(pan);
                    view.setCenter(obj.coordinate);
                },
                marker = function (obj) {
                    var coord4326 = obj.coordinate,
                        template = 'Coordinate is ({x} | {y})',
                        iconStyle = new ol.style.Style({
                            image: new ol.style.Icon({
                                scale: 0.6,
                                src: markerImage,
                                anchor: [0.5, 1],
                            }),
                            text: new ol.style.Text({
                                offsetY: 15,
                                text: ol.coordinate.format(coord4326, template, 2),
                                font: '15px Open Sans,sans-serif',
                                fill: new ol.style.Fill({color: '#111'}),
                                stroke: new ol.style.Stroke({
                                    color: '#eee', width: 2
                                })
                            })
                        }),
                        feature = new ol.Feature({
                            type: 'removable',
                            geometry: new ol.geom.Point(obj.coordinate)
                        });

                    feature.setStyle(iconStyle);

                    var name = prompt("Please enter the name", "My Point");

                    if (name == null) {
                        name = "";
                    }

                    //Save Name to Label and to JSON, refresh Layer
                    feature.getStyle().getText().setText(name);
                    feature.set('name', name);

                    vectorLayer.getSource().addFeature(feature);
                    var  format = new ol.format.GeoJSON();
                    var data;
                    data = format.writeFeatures(vectorLayer.getSource().getFeatures(), {decimals: 6});
                    $('#geojson').val(data);
                };

            var existingFeatures = new ol.format.GeoJSON().readFeatures(existingGeoJSON);
            vectorLayer.getSource().addFeatures(existingFeatures);
            var listOfExistingFeatures = vectorLayer.getSource().getFeatures();
            for (var partFeature of listOfExistingFeatures) {

                var markerStyle = new ol.style.Style({
                    image: new ol.style.Icon({
                        scale: .6,
                        src: markerImage,
                        anchor: [0.5, 1]
                    }),
                    text: new ol.style.Text({
                        offsetY: 15,
                        text: partFeature.get('name'),
                        font: '15px Open Sans,sans-serif',
                        fill: new ol.style.Fill({color: '#111'}),
                        stroke: new ol.style.Stroke({
                            color: '#eee', width: 2
                        })
                    })
                });

                partFeature.setStyle(markerStyle);
            }

            var contextmenu_items = [
                {
                    text: 'Add a Marker',
                    icon: markerImage,
                    callback: marker
                }
            ];
            var contextmenu = new
            ContextMenu({
                width: 180,
                default_items: false,
                items: contextmenu_items
            });
            map.addControl(contextmenu);

            var removeMarker = function (obj) {
                vectorLayer.getSource().removeFeature(obj.data.marker);

                var  format = new ol.format.GeoJSON();
                var data;
                data = format.writeFeatures(vectorLayer.getSource().getFeatures(), {decimals: 6});
                $('#geojson').val(data);
            };

            var editMarker = function (obj) {
                var name = prompt("Please enter the name", "My Point");
                obj.data.marker.getStyle().getText().setText(name);
                obj.data.marker.set('name', name);
                var  format = new ol.format.GeoJSON();
                var data;
                data = format.writeFeatures(vectorLayer.getSource().getFeatures(), {decimals: 6});
                $('#geojson').val(data);
                vectorLayer.getSource().changed();
            };

            var editMarkerItem = {
                text: 'Edit this Marker',
                icon: markerImage,
                callback: editMarker
            };

            var removeMarkerItem = {
                text: 'Remove this Marker',
                icon: markerImage, callback: removeMarker
            };

            var changed = false;
            contextmenu.on('open', function (evt) {
                var feature = map.forEachFeatureAtPixel(evt.pixel, function (ft, l) {
                    return ft;
                });
                if (feature &&
                    feature.get('type') == 'removable') {
                    contextmenu.clear();
                    removeMarkerItem.data = {
                        marker: feature
                    };
                    editMarkerItem.data = {
                        marker: feature
                    };
                    contextmenu.push(editMarkerItem);
                    contextmenu.push(removeMarkerItem);
                    changed = true;
                } else if (changed) {
                    contextmenu.clear();
                    contextmenu.extend(contextmenu_items);
                    //contextmenu.extend(contextmenu.getDefaultItems());
                    changed = false;
                }
            });
            map.on('pointermove', function (e) {
                if (e.dragging) return;

                var pixel = map.getEventPixel(e.originalEvent);
                var hit = map.hasFeatureAtPixel(pixel);

                map.getTarget().style.cursor = hit ? 'pointer' : '';
            });

        })(window, document);
    });
</script>